# Rakuen Web UI リデザイン仕様書

## 1. 概要

現行の`rakuen/webui/`をリデザインし、2画面構成(Activity / Tmux View)+ 共通ヘッダー/フッターのUIに変更する。

### 1.1 現行構成

| 項目 | 内容 |
|------|------|
| フロントエンド | `rakuen/webui/static/` (Vanilla JS/HTML/CSS, 3ファイル) |
| バックエンド | `rakuen/webui/app.py` (Python stdlib HTTP server) |
| エージェント | 10体: UI-chan(rakuen:0.0), AI-chan(multiagent:0.0), Kobito 1-8(multiagent:0.1-0.8) |
| 通信方式 | YAMLファイル(`queue/uichan_to_aichan.yaml`, `queue/tasks/kobito{N}.yaml`, `queue/reports/kobito{N}_report.yaml`) |

### 1.2 変更目的

- メイン画面: エージェント間の指示/報告フローを可視化
- サブ画面: 全10エージェントのtmux出力を一括監視
- 共通UI: 設定管理、プリセットコマンド、キャンセル操作の統合

---

## 2. 画面構成

### 2.1 全体レイアウト

```
+================================================================+
| HEADER (固定, 48px)                                             |
| [Activity] [Tmux View] | (o) tmux: OK | Valid: OK | [設定]     |
+================================================================+
|                                                                 |
|  メインコンテンツ領域 (タブで切替)                                 |
|  - Activity画面 または Tmux View画面                             |
|                                                                 |
+================================================================+
| FOOTER (固定, 80px)                                             |
| [プリセット v] [テキスト入力.....................] [Send] [Cancel] |
+================================================================+
```

- ヘッダーとフッターは全画面共通で固定表示
- メインコンテンツ領域はタブ切替で Activity / Tmux View を表示
- 画面切替は`display: none/flex`のトグルで実装(クライアントサイドルーティング不要)

---

## 3. メイン画面 (Activity)

### 3.1 機能概要

エージェント間の指示/報告をタイムライン形式で時系列表示する。

### 3.2 表示フォーマット

**委任(誰かへの指示):**
```
18:05:32  UI-chan --> AI-chan
          [cmd_003] WBSを更新してね
```

**単独作業(自分で実行):**
```
18:06:12  Kobito 1
          [subtask_001] done - ファイル作成完了
```

### 3.3 表示例

```
+------------------------------------------------------------------+
|                    Activity Timeline                              |
+------------------------------------------------------------------+
| 18:05:32  UI-chan --> AI-chan                                      |
|           [cmd_003] WBSを更新してね                                |
|                                                                   |
| 18:05:40  AI-chan --> Kobito 1                                    |
|           [subtask_001] hello1.mdを作成し、「おはよう1」と記載     |
|                                                                   |
| 18:05:40  AI-chan --> Kobito 2                                    |
|           [subtask_002] hello2.mdを作成し、「おはよう2」と記載     |
|                                                                   |
| 18:06:12  Kobito 1                                                |
|           [subtask_001] done - ファイル作成完了                    |
|                                                                   |
| 18:06:15  AI-chan                                                  |
|           dashboard.md updated - 進行中タスク更新                  |
|                                                                   |
| (自動スクロール: 最新エントリが下部に追加)                          |
+------------------------------------------------------------------+
```

### 3.4 視覚デザイン

| 要素 | スタイル |
|------|---------|
| タイムスタンプ | 左端、ミュートカラー(gray) |
| エージェント名 | 色分け表示(下表参照) |
| 矢印(`-->`) | Unicode矢印(U+2192: `-->`) |
| タスクID | `[brackets]`内、モノスペースフォント |
| 各エントリ | カード風の行、左ボーダーにエージェント色 |

**エージェント色:**

| エージェント | 色 | カラーコード |
|-------------|-----|-------------|
| UI-chan | Gold | `#d4a017` |
| AI-chan | Crimson | `#dc143c` |
| Kobito 1-8 | Steel Blue | `#4682b4` |

### 3.5 データソース

YAML通信ファイルをバックエンドで解析し、構造化データとして提供する。
YAMLファイルはリスト形式で追記される(上書きではない)ため、全履歴をタイムラインとして表示可能。

| ファイルパス | from | to | type | 書込形式 |
|-------------|------|-----|------|---------|
| `queue/uichan_to_aichan.yaml` | UI-chan | AI-chan | command | リスト追記 |
| `queue/tasks/kobito{N}.yaml` | AI-chan | Kobito N | assignment | リスト追記 |
| `queue/reports/kobito{N}_report.yaml` | Kobito N | (なし) | report | リスト追記 |

全ファイルパスは`$WORKSPACE_DIR`からの相対パス。

### 3.6 ダッシュボードサイドパネル

Activity画面の右側にサイドパネルとして`dashboard.md`の内容を表示する。

```
+------------------------------------------+------------------+
|                                          |                  |
|  Activity Timeline                       |  Dashboard       |
|  (タイムライン表示)                       |  (dashboard.md)  |
|                                          |                  |
|  18:05:32  UI-chan --> AI-chan            |  ## 進行中       |
|            [cmd_003] WBSを更新してね      |  - タスクA: 実行中|
|                                          |  - タスクB: 完了  |
|  18:05:40  AI-chan --> Kobito 1           |                  |
|            [subtask_001] hello1.md作成    |  ## 本日の戦果    |
|                                          |  - 3件完了       |
|                                          |                  |
+------------------------------------------+------------------+
          左 70%                                右 30%
```

| 要素 | 仕様 |
|------|------|
| 配置 | Activity画面の右30% |
| 内容 | `$WORKSPACE_DIR/dashboard.md`の内容を最小限Markdownパーサでレンダリング |
| MD対応範囲 | 見出し(`#`~`###`), リスト(`-`, `*`), 太字(`**`), コード(`` ` ``)のみ。それ以外はプレーンテキスト表示 |
| 更新 | Activityと同じポーリング間隔で更新 |
| ファイル未存在時 | 「No dashboard data」を表示 |

---

## 4. サブ画面 (Tmux View)

### 4.1 機能概要

全10エージェントのtmux出力を1画面で同時表示する。

### 4.2 レイアウト

```
+-----------------------------------+----------+----------+----------+
|                                   | AI-chan   | Kobito 1 | Kobito 2 |
|                                   |          |          |          |
|                                   |          |          |          |
|       UI-chan                      +----------+----------+----------+
|       (大きく表示)                  | Kobito 3 | Kobito 4 | Kobito 5 |
|       幅: 50%                      |          |          |          |
|                                   |          |          |          |
|                                   +----------+----------+----------+
|                                   | Kobito 6 | Kobito 7 | Kobito 8 |
|                                   |          |          |          |
|                                   |          |          |          |
+-----------------------------------+----------+----------+----------+
         左 50%                              右 50% (3x3 グリッド)
```

### 4.3 レイアウト仕様

| 領域 | 配置 | 内容 |
|------|------|------|
| 左パネル | 幅50%, 高さ100% | UI-chan (rakuen:0.0) |
| 右パネル | 幅50%, CSS Grid 3x3 | AI-chan + Kobito 1-8 (9エージェント) |

### 4.4 右パネル グリッド配置

| 行 | 列1 | 列2 | 列3 |
|----|-----|-----|-----|
| 1 | AI-chan | Kobito 1 | Kobito 2 |
| 2 | Kobito 3 | Kobito 4 | Kobito 5 |
| 3 | Kobito 6 | Kobito 7 | Kobito 8 |

### 4.5 各ペインウィジェット

```
+---------------------------+
| [色] Agent Name           |  <-- ヘッダーバー(24px)
+---------------------------+
| $ claude --dangerously... |  <-- モノスペース出力
| ...                       |
| ...                       |
| (スクロール可能)            |
+---------------------------+
```

| 要素 | スタイル |
|------|---------|
| ヘッダー | エージェント名 + 色インジケータ(左ボーダー) |
| 出力領域 | モノスペースフォント、ダーク背景(`#1a1a2e`) |
| スクロール | 各ペイン独立スクロール、自動下端スクロール |

### 4.6 ペインクリック時の拡大表示

グリッド内のペインをクリックすると、モーダルオーバーレイで拡大表示する。

```
+------------------------------------------------------------------+
| [X]                                                              |
|                                                                  |
|  Kobito 3                                                        |
|  --------------------------------------------------------        |
|  $ claude --dangerously-skip-permissions                         |
|  ...                                                             |
|  (フル幅・フル高さでログ表示)                                      |
|  ...                                                             |
|                                                                  |
+------------------------------------------------------------------+
```

| 要素 | 仕様 |
|------|------|
| トリガー | ペインウィジェットのクリック |
| 表示 | モーダルオーバーレイ(画面の90% x 90%) |
| 内容 | クリックしたエージェントのログを大きく表示 |
| 閉じる | [X]ボタン、Escキー、オーバーレイ外クリック |
| ポーリング | モーダル表示中も該当ペインのみ更新継続 |

---

## 5. 共通ヘッダー

### 5.1 レイアウト

```
+------------------------------------------------------------------+
| [Activity] [Tmux View]  | (o) tmux: OK  (o) Valid: OK  Port:8080 | [歯車]
+------------------------------------------------------------------+
```

### 5.2 要素

| 要素 | 機能 | 詳細 |
|------|------|------|
| タブボタン | 画面切替 | Activity / Tmux View。アクティブタブは背景色変更 |
| tmuxステータス | 接続状態表示 | 緑dot=正常、赤dot=エラー、灰dot=不明 |
| Validationステータス | 検証結果表示 | OK / WARNINGS |
| ポート表示 | 現在のポート番号 | `Port: 8080` |
| 設定ボタン | 設定モーダル表示 | 歯車アイコン(U+2699) |

---

## 6. 設定モーダル

### 6.1 レイアウト

```
+-----------------------------------+
|  設定                        [X]  |
|                                   |
|  自動更新:    [ON]  OFF           |
|  更新間隔:    [2s]  5s   10s     |
|  ログ行数:    100  [300]  500  1K |
|  テーマ:      [Dark]  Light       |
|  フォントサイズ: S  [M]  L        |
|                                   |
|                      [Close]      |
+-----------------------------------+
```

### 6.2 設定項目

| 項目 | 選択肢 | デフォルト | 保存先 |
|------|--------|-----------|--------|
| 自動更新 | ON / OFF | ON | localStorage |
| 更新間隔 | 2秒 / 5秒 / 10秒 | 2秒 | localStorage |
| ログ行数 | 100 / 300 / 500 / 1000 | 300 | localStorage |
| テーマ | Dark(戦国風) / Light(モダン) | Dark | localStorage |
| フォントサイズ | S / M / L | M | localStorage |

- 設定はページリロード後も維持
- テーマ切替はCSS変数(`--bg-primary`等)を`:root`で切替
- **Darkテーマ**: 現行の戦国風デザイン(ダーク背景, gold/crimson/steel-blueアクセント)
- **Lightテーマ**: モダンライト(白系背景, 一般的なUIカラーパレット。戦国風アクセント色は使用しない)

---

## 7. 共通フッター

### 7.1 レイアウト

```
+------------------------------------------------------------------+
| [プリセット v] [____テキスト入力____________________] [Send] [Cancel] |
+------------------------------------------------------------------+
```

### 7.2 要素

| 要素 | 機能 | 詳細 |
|------|------|------|
| プリセットドロップダウン | 定型コマンド選択 | `presets.json`から読み込み。選択するとテキスト入力欄に反映(自動送信しない)。ユーザーが内容を編集してからSendで送信可能。(注: 現行UIはクリック即送信だが、新UIでは編集可能に変更) |
| テキスト入力 | コマンド入力 | 複数行対応textarea(2行表示)。Shift+Enterで改行、Enterで送信。現行UIと同じ挙動を維持 |
| Sendボタン | コマンド送信 | Gold色。UI-chanペイン(rakuen:0.0)にtmux send-keysで送信 |
| Cancelボタン | キャンセル指示 | Red色。定型テキスト「Stop current work and report the current state.」をUI-chanに送信 |

### 7.3 送信先

全てのコマンドは`rakuen:0.0`(UI-chan)に送信される。他エージェントへの直接送信は不可。

---

## 8. バックエンドAPI変更

### 8.1 新規エンドポイント

#### `GET /api/activity`

YAML通信ファイルを解析し、アクティビティエントリを返す。

**レスポンス:**
```json
{
  "entries": [
    {
      "timestamp": "2026-01-30T18:05:32",
      "from": "uichan",
      "from_label": "UI-chan",
      "to": "aichan",
      "to_label": "AI-chan",
      "action": "WBSを更新してね",
      "task_id": "cmd_003",
      "type": "command"
    },
    {
      "timestamp": "2026-01-30T18:06:12",
      "from": "kobito1",
      "from_label": "Kobito 1",
      "to": null,
      "to_label": null,
      "action": "done - ファイル作成完了",
      "task_id": "subtask_001",
      "type": "report"
    }
  ]
}
```

**解析対象ファイル:**

| # | ファイルパス | 説明 |
|---|-------------|------|
| 1 | `$WORKSPACE_DIR/queue/uichan_to_aichan.yaml` | UI-chan --> AI-chan 指示キュー |
| 2 | `$WORKSPACE_DIR/queue/tasks/kobito{1-8}.yaml` | AI-chan --> Kobito N タスク割当 |
| 3 | `$WORKSPACE_DIR/queue/reports/kobito{1-8}_report.yaml` | Kobito N 完了報告 |
| 4 | `$WORKSPACE_DIR/dashboard.md` | AI-chanステータス更新 |

**YAML解析方針:**
Python stdlibにはYAMLパーサが存在しないため、本プロジェクトで使用する単純なYAMLサブセット(key: value、リスト項目)のみを処理する最小パーサ関数を作成する。

**エントリソート:** timestamp昇順。timestampなしは末尾に配置。

#### `GET /api/panes`

全10ペインのtmux出力を一括取得する。

**クエリパラメータ:**

| パラメータ | 型 | デフォルト | 説明 |
|-----------|-----|-----------|------|
| lines | int | 300 | 各ペインの取得行数(50-1000) |

**レスポンス:**
```json
{
  "panes": {
    "uichan": { "agent": "uichan", "lines": 300, "text": "..." },
    "aichan": { "agent": "aichan", "lines": 300, "text": "..." },
    "kobito1": { "agent": "kobito1", "lines": 300, "text": "..." },
    "kobito2": { "agent": "kobito2", "lines": 300, "text": "..." },
    "kobito3": { "agent": "kobito3", "lines": 300, "text": "..." },
    "kobito4": { "agent": "kobito4", "lines": 300, "text": "..." },
    "kobito5": { "agent": "kobito5", "lines": 300, "text": "..." },
    "kobito6": { "agent": "kobito6", "lines": 300, "text": "..." },
    "kobito7": { "agent": "kobito7", "lines": 300, "text": "..." },
    "kobito8": { "agent": "kobito8", "lines": 300, "text": "..." }
  }
}
```

### 8.2 既存エンドポイント (変更なし)

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/api/health` | ヘルスチェック |
| GET | `/api/status` | tmuxステータス + バリデーション |
| GET | `/api/pane` | 単一エージェントのペイン出力 |
| POST | `/api/send` | UI-chanにコマンド送信 |
| GET | `/api/presets` | プリセット定義一覧 |

---

## 9. 技術スタック

### 9.1 推奨: Vanilla JS + ES Modules

外部依存ゼロを維持し、ES Modulesでコンポーネント分割を実現する。

**選定理由:**

| 理由 | 詳細 |
|------|------|
| 哲学一致 | プロジェクトの「外部依存ゼロ」方針に合致 |
| ビルド不要 | `<script type="module">`でブラウザネイティブ対応 |
| 十分な構造化 | import/exportでコンポーネント分割が可能 |
| オフライン動作 | CDN不要。WSL2ローカル環境で確実に動作 |
| 複雑度適正 | 2画面、5-6コンポーネント。フレームワーク不要レベル |

### 9.2 バックエンド

Python標準ライブラリのみ(変更なし)。

---

## 10. フロントエンド ファイル構成

### 10.1 ディレクトリ構造

```
rakuen/webui/static/
  index.html                        # メインHTML(書換)
  style.css                         # グローバルCSS(書換)
  js/
    app.js                          # エントリポイント
    api.js                          # APIクライアント
    state.js                        # 状態管理
    settings.js                     # 設定管理(localStorage)
    components/
      header.js                     # ヘッダー(タブ + ステータス + 設定ボタン)
      footer.js                     # フッター(入力 + プリセット + 送信/キャンセル)
      activity.js                   # アクティビティタイムライン画面
      tmux-view.js                  # Tmuxマルチペイン画面
      tmux-pane.js                  # 単一ペインウィジェット
      settings-modal.js             # 設定モーダルダイアログ
    utils/
      dom.js                        # DOM操作ヘルパー
      format.js                     # エージェント名/タイムスタンプ整形
```

### 10.2 モジュール責務

| モジュール | 責務 |
|-----------|------|
| `app.js` | 初期化、画面切替ルーティング、ポーリング管理 |
| `api.js` | 全APIエンドポイントのfetchラッパー |
| `state.js` | 集約状態管理(observable pattern)。画面/設定/データを一元管理 |
| `settings.js` | localStorage読み書き、デフォルト値管理 |
| `header.js` | タブボタン描画、ステータスドット更新、設定ボタン |
| `footer.js` | テキスト入力、プリセットドロップダウン、Send/Cancelボタン |
| `activity.js` | `/api/activity`データをタイムラインUIに描画 |
| `tmux-view.js` | 左右2カラム + 右3x3グリッドレイアウト管理 |
| `tmux-pane.js` | 単一ペインの描画(ヘッダー + 出力テキスト + スクロール) |
| `settings-modal.js` | モーダル表示/非表示、設定値の反映 |
| `dom.js` | `el()`, `qs()`, `qsa()`等のDOM操作ショートハンド |
| `format.js` | エージェントラベル/色マッピング、タイムスタンプ整形 |

---

## 11. ポーリング設計

### 11.1 方針

- アクティブ画面のデータのみポーリング(不要な通信を削減)
- ブラウザタブが非アクティブの場合は全ポーリングを停止
- ステータスは全画面共通で低頻度ポーリング

### 11.2 ポーリング対象

| 画面 | エンドポイント | 間隔 | 条件 |
|------|--------------|------|------|
| Activity | `GET /api/activity` | 設定値(2/5/10秒) | Activity画面表示中 かつ ブラウザタブがアクティブ |
| Tmux View | `GET /api/panes` | 設定値(2/5/10秒) | Tmux View画面表示中 かつ ブラウザタブがアクティブ |
| 共通 | `GET /api/status` | 30秒固定 | ブラウザタブがアクティブ |

### 11.3 ポーリング制御

- 自動更新OFF: ポーリング停止(`clearInterval`)
- 間隔変更: 現在のタイマーをリセットし新間隔で再開
- 画面切替時: 即座にアクティブ画面のデータを取得
- **ブラウザタブ非アクティブ**: `document.visibilitychange`イベントで検知し、全ポーリングを停止
- **ブラウザタブ復帰**: タブがアクティブに戻った時点で即座にデータ取得し、ポーリングを再開

---

## 12. 実装計画

### Phase 1: バックエンドAPI追加

| # | タスク | 対象ファイル |
|---|--------|-------------|
| 1 | 最小YAMLパーサ関数をapp.pyに追加 | `rakuen/webui/app.py` |
| 2 | `GET /api/activity`エンドポイント実装 | `rakuen/webui/app.py` |
| 3 | `GET /api/panes`エンドポイント実装 | `rakuen/webui/app.py` |

### Phase 2: フロントエンド基盤

| # | タスク | 対象ファイル |
|---|--------|-------------|
| 4 | DOMヘルパー/フォーマットユーティリティ作成 | `js/utils/dom.js`, `js/utils/format.js` |
| 5 | 状態管理モジュール作成 | `js/state.js` |
| 6 | APIクライアント作成 | `js/api.js` |
| 7 | 設定管理モジュール作成 | `js/settings.js` |

### Phase 3: HTML/CSS構造

| # | タスク | 対象ファイル |
|---|--------|-------------|
| 8 | HTML構造を2画面コンテナ+ヘッダー/フッターに書換 | `index.html` |
| 9 | CSS書換(テーマ変数、グリッド、タイムライン) | `style.css` |

### Phase 4: コンポーネント実装

| # | タスク | 対象ファイル |
|---|--------|-------------|
| 10 | ヘッダーコンポーネント(タブ + ステータス) | `js/components/header.js` |
| 11 | 設定モーダル | `js/components/settings-modal.js` |
| 12 | フッターコンポーネント(入力 + プリセット + 送信/キャンセル) | `js/components/footer.js` |
| 13 | アクティビティタイムライン | `js/components/activity.js` |
| 14 | 単一ペインウィジェット | `js/components/tmux-pane.js` |
| 15 | マルチペインビュー | `js/components/tmux-view.js` |

### Phase 5: 統合

| # | タスク | 対象ファイル |
|---|--------|-------------|
| 16 | エントリポイント(全コンポーネント接続) | `js/app.js` |
| 17 | 旧app.js削除、全機能動作確認 | `static/app.js`(削除) |

---

## 13. リスクと対策

| リスク | 影響度 | 対策 |
|-------|--------|------|
| Python stdlibにYAMLパーサなし | 高 | プロジェクトで使用する単純なYAMLサブセットのみ対応する最小パーサを作成 |
| YAMLファイルが未作成(初回起動時等) | 中 | FileNotFoundErrorをキャッチし空配列を返す |
| 10ペイン一括取得の遅延 | 低 | ~50ms/pane x 10 = ~500ms。2秒ポーリング間隔で十分許容範囲 |
| ES Modulesブラウザ互換性 | 低 | WSL2上のChrome/Edgeは確実にサポート |

---

## 14. 検証方法

### 14.1 起動確認

```bash
python3 rakuen/webui/app.py
# ブラウザで http://127.0.0.1:8080 にアクセス
```

### 14.2 機能検証チェックリスト

| # | 検証項目 | 期待結果 |
|---|---------|---------|
| 1 | Activity画面表示 | YAMLファイルが存在すればタイムラインにエントリ表示 |
| 2 | Activity画面(ファイルなし) | 空状態の表示(エラーなし) |
| 3 | Tmux View画面表示 | 10ペイン全てがグリッド表示(左: UI-chan大、右: 3x3) |
| 4 | タブ切替 | Activity <--> Tmux View の切替が即座に動作 |
| 5 | 設定モーダル | 歯車クリックでモーダル表示、設定変更が即座に反映 |
| 6 | テーマ切替 | Dark/Light切替でUI全体の配色が変更 |
| 7 | フォントサイズ変更 | S/M/L切替でログ表示のフォントサイズが変更 |
| 8 | プリセット選択 | ドロップダウンから選択 --> テキスト入力欄に反映(送信されない) |
| 9 | Send | テキスト入力後にSendクリック --> UI-chanペインにコマンド送信 |
| 10 | Cancel | Cancelクリック --> 定型テキストがUI-chanに送信 |
| 11 | 自動更新OFF | ポーリングが停止し、データ更新が止まる |
| 12 | ページリロード | 設定(テーマ、間隔等)がlocalStorageから復元 |

---

## 15. 制約事項

| 制約 | 説明 |
|------|------|
| 外部依存ゼロ | フロントエンド/バックエンドともに外部ライブラリを使用しない |
| Python stdlib only | バックエンドはPython標準ライブラリのみ使用 |
| WSL2環境 | WSL2上での動作を前提とする |
| localhost限定 | `127.0.0.1`バインドのみ(外部公開しない) |
| リポジトリ非汚染 | ランタイムファイルは`~/rakuen/`に配置(リポジトリ内に生成しない) |
